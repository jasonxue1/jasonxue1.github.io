<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>双重 AES 加密与解密示例</title>
</head>
<body>
    <h2>双重 AES 加密与解密示例</h2>

    <textarea id="inputText" placeholder="输入要加密的文本"></textarea><br>
    <input type="text" id="userKey" placeholder="输入用户密钥"><br>
    <button onclick="encryptText()">加密</button>
    <br><br>
    <textarea id="encryptedText" placeholder="加密后的文本" readonly></textarea><br><br>
    <button onclick="decryptText()">解密</button>
    <br><br>
    <textarea id="decryptedText" placeholder="解密后的文本" readonly></textarea>

    <script>
        // 预设的密钥，可以自定义
        const presetKey = Uint8Array.from([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]);

        // AES 加密函数
        async function encryptText() {
            const inputText = document.getElementById('inputText').value;
            const userKey = document.getElementById('userKey').value;

            try {
                // 第一次加密，使用用户输入的密钥
                const userKeyArray = new TextEncoder().encode(userKey);
                const encryptedUserKey = await window.crypto.subtle.encrypt(
                    { name: 'AES-CBC', iv: presetKey.slice(0, 16) }, 
                    userKeyArray, 
                    userKeyArray
                );

                // 第二次加密，使用预设的密钥
                const presetKeyArray = presetKey;
                const textEncoder = new TextEncoder();
                const data = textEncoder.encode(inputText);
                const encryptedData = await window.crypto.subtle.encrypt(
                    { name: 'AES-CBC', iv: presetKeyArray.slice(0, 16) }, 
                    presetKeyArray, 
                    data
                );

                // 将加密后的结果显示在文本框中
                const encryptedArray = new Uint8Array(encryptedData);
                const encryptedText = btoa(String.fromCharCode(...encryptedArray));
                document.getElementById('encryptedText').value = encryptedText;
            } catch (error) {
                console.error('加密失败:', error);
            }
        }

        // AES 解密函数
        async function decryptText() {
            const encryptedText = document.getElementById('encryptedText').value;
            const userKey = document.getElementById('userKey').value;

            try {
                // 使用预设的密钥解密
                const encryptedArray = new Uint8Array(atob(encryptedText).split('').map(char => char.charCodeAt(0)));
                const decryptedPresetKey = await window.crypto.subtle.decrypt(
                    { name: 'AES-CBC', iv: presetKey.slice(0, 16) }, 
                    presetKey, 
                    encryptedArray
                );

                // 使用用户输入的密钥解密
                const decryptedUserKey = await window.crypto.subtle.decrypt(
                    { name: 'AES-CBC', iv: presetKey.slice(0, 16) }, 
                    decryptedPresetKey, 
                    decryptedPresetKey
                );

                // 将解密后的结果显示在文本框中
                const decryptedArray = new Uint8Array(decryptedUserKey);
                const decryptedText = new TextDecoder().decode(decryptedArray);
                document.getElementById('decryptedText').value = decryptedText;
            } catch (error) {
                console.error('解密失败:', error);
            }
        }
    </script>
</body>
</html>
